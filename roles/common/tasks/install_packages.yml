---
#
# roles/common/tasks/install_packages.yml
#

- name: upgrade apt packages manually 
  shell: 'apt-get update'
  args:
    warn: no
  changed_when: false
  become: true

- name: copy dpkg lock script
  copy:
    src: 'check_lock.sh'
    dest: '/usr/local/bin/check_lock.sh'
    mode: 'a+x'
  become: true

- name: wait for dpkg lock to release
  shell: '/usr/local/bin/check_lock.sh'
  changed_when: false

- name: install packages
  apt: 
    name: '{{ item }}' 
    state: present
    update_cache: no
  with_items: 
    - '{{ packages }}'
  become: true
